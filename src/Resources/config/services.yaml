imports:
    - { resource: transport.yaml }

services:
    _defaults:
        autowire: true
        autoconfigure: true

    Nkamuo\NotificationTrackerBundle\:
        resource: '../../*'
        exclude:
            - '../../{DependencyInjection,Entity,Resources,Tests,Migration}'
            - '../../NotificationTrackerBundle.php'

    # Core Services with proper logger configuration
    Nkamuo\NotificationTrackerBundle\Service\MessageTracker:
        tags:
            - { name: monolog.logger, channel: notification_tracker }

    # Messenger Middleware for notification tracking stamps
    Nkamuo\NotificationTrackerBundle\Messenger\Middleware\NotificationTrackingMiddleware:
        tags:
            - { name: messenger.middleware, priority: 100 }
            - { name: monolog.logger, channel: notification_tracker_middleware }

    # Webhook Provider Registry
    Nkamuo\NotificationTrackerBundle\Service\WebhookProviderRegistry:
        arguments: []

    # Webhook Processor with explicit service dependencies
    Nkamuo\NotificationTrackerBundle\Service\WebhookProcessor:
        arguments:
            $entityManager: '@doctrine.orm.entity_manager'
            $messageTracker: '@Nkamuo\NotificationTrackerBundle\Service\MessageTracker'
            $notificationTracker: '@Nkamuo\NotificationTrackerBundle\Service\NotificationTracker'
            $providerRegistry: '@Nkamuo\NotificationTrackerBundle\Service\WebhookProviderRegistry'
            $logger: '@logger'
            $messageBus: '@messenger.bus.default'
            $asyncProcessing: true
            $verifySignatures: true
        tags:
            - { name: monolog.logger, channel: notification_tracker_webhook }

    # Webhook Providers (with optional secrets)
    Nkamuo\NotificationTrackerBundle\Webhook\Provider\SendGridWebhookProvider:
        arguments:
            $secret: ''
        tags:
            - { name: notification_tracker.webhook_provider }

    Nkamuo\NotificationTrackerBundle\Webhook\Provider\MailgunWebhookProvider:
        arguments:
            $secret: ''
        tags:
            - { name: notification_tracker.webhook_provider }

    # Remove repository services - they're auto-configured by Doctrine
    # Just ensure they're tagged properly in the Entity annotations